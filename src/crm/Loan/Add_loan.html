<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>BASICA! A Free Bootstrap3 HTML5 CSS3 Template by Vactual Art</title>

    <!-- Bootstrap Core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">

    <!-- Custom CSS -->
	<link rel="stylesheet" href="../css/main.css">
    <link href="../css/custom.css" rel="stylesheet">
	
	<script src="//use.edgefonts.net/bebas-neue.js"></script>

    <!-- Custom Fonts & Icons -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,600,800' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="../css/icomoon-social.css">
	<link rel="stylesheet" href="../css/font-awesome.min.css">
    
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        
        th, td {
            text-align: left;
            padding: 8px;
        }
        
        tr:nth-child(even){background-color: #f2f2f2}
        
        th {
            background-color: #aec62c;
            color: white;
        }
    </style>

	<script src="../js/modernizr-2.6.2-respond-1.1.0.min.js"></script>
	

</head>

    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
        
    <div id="header"></div>

        <!-- Page Title -->
		<div class="section section-breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h1>สร้างใบกู้เงิน</h1>
					</div>
				</div>
			</div>
		</div>
		
		
        <div class="section">
	    	<div class="container">
                <h2>สร้างใบกู้เงิน</h2>
                <hr>

                <div class="form-group has-feedback">
                        <label class="col-lg-3 control-label">Document No.</label>
                        <div class="col-lg-3">
                            <input type="text" class="form-control" id="id" value="" readonly>
                        </div>
                        <label class="col-lg-3 control-label">วันที่</label>
                        <div class="col-lg-3">
                            <input type="text" class="form-control" id="date_po" value="17/9/2018" readonly>
                        </div>
                </div>
                <hr>
                <div id="customer" class="form-group has-feedback"></div>
                <br>
                <div class="form-group has-feedback">
                        <label class="col-lg-3 control-label">จำนวนเงิน</label>
                        <div class="col-lg-3">
                            <input type="text" class="form-control" id="money1" value="" >
                        </div>
                        <label class="col-lg-3 control-label">ยืนยันจำนวนเงิน</label>
                        <div class="col-lg-3">
                            <input type="text" class="form-control" id="money2" value="" >
                        </div>
                </div>
                <br>
                <br>
                <div align="right">
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="add_list">เพิ่มรายการ</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="remove_list">ยกเลิกรายการ</button>
                </div>
				<div class="row">                    
				<div class="col-sm-12">
                    <hr>
                        <table id = "new_table">
                                <tr>
                                  <th><center>
                                        <label>
                                            <input type="checkbox" id="checkAll"><span class="text"></span>
                                        </label> All
                                    </center></th>
                                  <th><center>ลำดับ</center></th>
                                  <th><center>จำนวนเงิน</center></th>
                                  <th><center>สร้างโดย</center></th>
                                </tr>
                                <tbody id = new_data></tbody>
                              </table>	
                        <hr>
                        <table id = "old_data">
                            <tr>
                              <th><center>
                                    <label>
                                        <input type="checkbox" id="checkAll"><span class="text"></span>
                                    </label> All
                                </center></th>
                              <th><center>ลำดับ</center></th>
                              <th><center>จำนวนเงิน</center></th>
                              <th><center>สร้างโดย</center></th>
                            </tr>
                          </table>	
                          <hr>	
                          <div class="form-group has-feedback">
                                <label class="col-lg-3 control-label">พยาน</label>
                                <div class="col-lg-3">
                                    <input type="text" class="form-control" id="company" value="" >
                                </div>
                                <label class="col-lg-3 control-label">ผู้บริหาร</label>
                                <div class="col-lg-3">
                                    <input type="text" class="form-control" id="date_po" value="" >
                                </div>
                            </div>	
                            <br>
                            <br>
                            <hr>	
                    </div>
                    <div align="right">
                            <hr>
                                <a href="#" id="save_btn" class="btn">บันทึก</a>
                                <a href="../Loan/List_loan.html" class="btn">ย้อนกลับ</a>
                    </div>
                    
				</div>
            </div>
        </div>
		
	    <!-- End Our Clients -->


        <!-- Javascripts -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../js/jquery-1.9.1.min.js"><\/script>')</script>
        <script src="../js/bootstrap.min.js"></script>
		
		<!-- Scrolling Nav JavaScript -->
		<script src="../js/jquery.easing.min.js"></script>
        <script src="../js/scrolling-nav.js"></script>		

        
        
        <script>
            //Global variable
            var id = 0;
            var old_amount = 0;
            var CustomerList = [];
            var List = [];
            $("#header").load("../header.html");

            function print_table() {
                var tmp="";
                List.forEach(function (element, i) {
                    tmp += `
                                <tr>
                                <td><center><label><input type="checkbox" value="`+ i + `"><span class="text"></span></label></center></th>
                                <td><center>`+ (i + 1) + `</center></td>
                                <td><center>`+ element.amount +`</center></td>
                                <td><center>`+ element.DATE +`</center></td>
                                <td><center>`+ element.loanleft+`</center></td>
                                </tr>`;
                });
                $("#new_data").empty();
                $("#new_data").append(tmp);
            }

            async function check_value(_id,_amount){
                if(List[_id] == null) {
                    return;
                } else {
                    console.log(_id)
                    List[_id].loanleft += parseFloat(_amount);
                    check_value(++_id,_amount);
                }
            }

            function alertStatement(link) {
                var url = new URL(link);
                id = parseInt(url.searchParams.get("id"));
                if(id !== null){
                    $.getJSON("../../api/loanlist/" + id , function(data) {
                        var tmp = "";
                        request_customer(id);
                        data.forEach(function(element , i ) {
                            tmp += `<tr><td><center>`+ parseInt(i+1)+`</center></td>
                                <td><center>`+ element.amount +`</center></td>
                                <td><center>`+ element.DATE +`</center></td>
                                <td><center>`+ element.loanleft+`</center></td>`;
                        })
                        $("#id").val(id);
                        $("#old_data").append(tmp);
                    });
                } else {
                    $("#old_data").hide();
                    console.log("not have id")
                }
            }

            function load_old_amount() {
                $.getJSON("../../api/loan/" + id , function(data) {
                           old_amount = parseInt(data.amount);
                });
            }

            function getCustomerName(id) {
                $.getJSON("../../api/customer/" + id , function(data) {
                    CustomerList.push({
                        id:id,
                        firstname:data.firstname,
                        surname:data.surname
                    });
                    printCustomer();
                });
            }

            function printCustomer(){
                console.log(CustomerList)
                var item = "";
                CustomerList.forEach(element =>{
                           item += `
                            <label class="col-lg-3 control-label">ชื่อลูกค้า</label>
                            <div class="col-lg-3">
                                <input type="text" class="form-control" id="fname" value="`+element.firstname+`" readonly>
                            </div>
                            <label class="col-lg-3 control-label">นามสกุล</label>
                            <div class="col-lg-3">
                                <input type="text" class="form-control" id="lname" value="`+element.surname+`" readonly>
                            </div>
                        `;
                })
                $("#customer").empty();
                $("#customer").append(item);
            }

            function request_customer(id) {
                $.getJSON("../../api/customerlist/" + id , function(data) {
                    data.forEach(element => {
                        getCustomerName(element.customers_id);
                    })
                });
            }

            $( document ).ready(function() {
               alertStatement(window.location.href);
               load_old_amount();

               //Add List button 
               $("#add_list").click(function () {
                   var money1 = $("#money1").val();
                   var money2 = $("#money2").val();
                   var currentdate = new Date(); 
                   var datetime =   currentdate.getFullYear() + "-"
                                    + (currentdate.getMonth()+1)  + "-" 
                                    + currentdate.getDate();
                                    // + "T"  
                                    // + currentdate.getHours() + ":"  
                                    // + currentdate.getMinutes() + ":" 
                                    // + currentdate.getSeconds();
                   if(money1 == money2) {
                       if(parseFloat(money1) > old_amount) {
                           alert("กรอกเงินเกินจำนวน กรุณาตรวจสอบใหม่");
                           return;
                       }
                       old_amount -= parseFloat(money1);
                       //Add data to list
                       List.push({
                            amount: parseFloat(money1),
                            DATE: datetime,
                            loanleft: parseFloat(old_amount),
                            load_id:id
                       });
                       print_table();
                   } else {
                       alert("กรุณากรอกเงินให้ตรงกัน")
                   }
               });

               //for remove list
                $("#remove_list").click(async function () {
                    var id = $("#new_data input:checked").map(function () {
                        return $(this).attr("value")
                    }).get()
                    if (id.length != 0) {
                        for (var count = id.length; count > 0; count--) {
                            console.log("from remove list : " + id[count])
                            old_amount += parseFloat(List[id[count - 1]].amount)
                            await check_value(id[count - 1],List[id[count - 1]].amount)
                            List.splice(id[count - 1], 1)
                        }
                        print_table()
                    }
                    else return
                });

               //Save Button
               $("#save_btn").click(async function () {

                   save_list = function() {
                       return new Promise(resolve =>{
                           List.forEach(function ( element) {
                                $.post("../../api/loanlist/" ,{
                                    id:null,
                                    amount:element.amount,
                                    DATE:element.DATE,
                                    loanleft:element.loanleft,
                                    loan_id:parseInt($("#id").val())
                                },function(data){
                                    create_moneyStock(data.id,element.amount,data.loan_id);
                                });
                           });
                           resolve();
                       })
                   }

                   update_loan = function () {
                       return new Promise(resolve => {
                           $.post("../../api/loanUpdate/" + id , {
                               id: parseInt($("#id").val()),
                               amount:old_amount
                           })
                           resolve();
                       })
                   }

                   create_moneyStock = function (_id,_amount,_idLoan) {
                       return new Promise(resolve => {
                           $.post("../../api/moneystockGetLast" , {
                               id:null,
                               amount:_amount,
                               typeStock_id:1,
                               loanlist_id:_id,
                               loanlist_id_fromloan:_idLoan
                           })
                           resolve();
                       })
                   }
                   await save_list();
                   await update_loan();
                   location.reload();
               })
            });


        </script>